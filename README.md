Код переделал по правкам, правда не уверен, что оформление правильное.
